# 服务注册发现

## 一、服务注册

> service B 把自己注册到Service Registry

#### 1.1 注册中心

#### 1.1.1 实现原理

> 设计思想

1. 服务注册。接受来自服务提交的注册信息，并保存起来
2. 服务下线。接受服务的主动下线请求，并将服务从注册信息表中删除
3. 服务获取。调用方从注册中心拉取服务信息
4. 服务续约。服务健康检查，服务通过心跳保持（主动续约）告知注册中心服务
5. 服务剔除。注册中心将长时间不续约的服务实例从注册信息表中删除。
   1. 保护模式。

#### 1.2 服务端注册

1. 启动注册。在服务启动时完成并设置**有效期**，防止程序异常退出
2. 定时续期。
   1. 注册中心主动探活。
   2. 服务实例主动上报。
3. 退出撤销。应主动去撤销注册信息，便于调用方及时将请求分发到别的节点。【**Knuth-Shuffle算法，公平洗牌算法**】
   1. 剔除上限数量=当前注册表大小-触发自我保护机制阀值

## 二、服务发现

### 2.1 服务调用方

#### 2.1.2 问题点

1. 存量获取。service A启动，从service registry获取service b的已有节点
2. 增量监听。新增服务时，通知服务调用方
3. 应对服务发现故障。在内存里缓存一个可用节点列表

## 三、参考资料

1. [服务注册中心](https://mp.weixin.qq.com/s/WZ6HG-ZLFiBJLbE29vTr3g)