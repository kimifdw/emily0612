# 零拷贝技术

> 磁盘相关的文件读写操作都有使用到`page cache`技术

## 四次拷贝与四次上下文切换

### 总体流程

![deep-memory.jpg](/image/os/deep-memory.jpg)

1. 4次复制
   1. CPU 负责将数据从磁盘搬运到内核空间的 Page Cache 中；
   2. CPU 负责将数据从内核空间的 Socket 缓冲区搬运到的网络中；
   3. CPU 负责将数据从内核空间的 Page Cache 搬运到用户空间的缓冲区；
   4. CPU 负责将数据从用户空间的缓冲区搬运到内核空间的 Socket 缓冲区中；
2. 4次上下文切换
   1. read 系统调用时：用户态切换到内核态；
   2. read 系统调用完毕：内核态切换回用户态；
   3. write 系统调用时：用户态切换到内核态；
   4. write 系统调用完毕：内核态切换回用户态；

### DMA技术

定义。在进行内存和 I/O 设备的数据传输的时候，我们不再通过 CPU 来控制数据传输，由DMA来进行控制

### 零拷贝技术

1. 定义。计算机执行操作时，CPU 不需要先将数据从某处内存复制到另一个特定区域。
2. 特点。不由CPU来全程负责内存中的数据写入其他组件，仅仅只负责管理
3. 实现方式
   1. sendfile。一次代替 read/write 系统调用，通过使用 DMA 技术以及传递文件描述符
   2. mmap。仅代替 read 系统调用，将内核空间地址映射为用户空间地址，write 操作直接作用于内核空间
   3. splice
   4. 直接Direct I/O。读写操作直接在磁盘上进行，不使用 **page cache** 机制，通常结合用户空间的用户缓存使用

### 参考资料

1. [深入理解零拷贝技术](https://mp.weixin.qq.com/s/9CAU6zg0F3CqLXJxpg1alA)

